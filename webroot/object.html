<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Draugnet – Report via Object</title>

  <link href="css/fontawesome.all.min.css" rel="stylesheet" />
  <link href="css/bootstrap.min.css" rel="stylesheet" />
  <link href="css/style.css" rel="stylesheet" />

  <script src="js/main.js"       defer></script>
  <script src="js/tokenstore.js" defer></script>
  <script src="js/menu.js"       defer></script>
  <script src="js/visualizer.js" defer></script>
  <script type="module" src="js/metadata.js" defer></script>

  <style>
    /* ── Custom template combobox ────────────────────────────────── */
    .tmpl-combobox { position: relative; }

    .tmpl-combobox-wrap {
      display: flex;
      align-items: center;
      gap: .5rem;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: .375rem;
      padding: 0 .75rem;
      transition: border-color .15s, box-shadow .15s;
    }
    .tmpl-combobox-wrap:focus-within {
      border-color: var(--bs-primary);
      box-shadow: 0 0 0 .2rem rgba(var(--bs-primary-rgb), .15);
    }
    .tmpl-combobox-wrap .fa-magnifying-glass {
      color: var(--placeholder);
      font-size: .8rem;
      flex-shrink: 0;
    }
    #template-select {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      padding: .5rem 0;
      font-size: .875rem;
      color: var(--app-fg);
      min-width: 0;
    }
    #template-select::placeholder { color: var(--placeholder); }

    .tmpl-clear {
      background: none;
      border: none;
      padding: .15rem .1rem;
      color: var(--placeholder);
      cursor: pointer;
      font-size: .75rem;
      line-height: 1;
      flex-shrink: 0;
      display: none;
    }
    .tmpl-clear:hover { color: var(--app-fg); }

    .tmpl-dropdown {
      display: none;
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      z-index: 300;
      background: var(--sidebar-bg);
      border: 1px solid var(--card-border);
      border-radius: .4rem;
      box-shadow: 0 6px 24px rgba(0,0,0,.4);
      overflow: hidden;
    }
    .tmpl-list {
      max-height: 280px;
      overflow-y: auto;
      padding: .3rem 0;
    }
    .tmpl-item {
      padding: .4rem .85rem;
      font-size: .82rem;
      color: var(--bs-secondary-color);
      cursor: pointer;
      transition: background .08s, color .08s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .tmpl-item:hover,
    .tmpl-item.tmpl-focused {
      background: var(--hover-bg);
      color: var(--app-fg);
    }
    .tmpl-item mark {
      background: rgba(var(--bs-warning-rgb), .25);
      color: inherit;
      border-radius: 2px;
      padding: 0 1px;
    }
    .tmpl-empty {
      padding: .75rem .85rem;
      font-size: .82rem;
      color: var(--placeholder);
      text-align: center;
    }

    /* Template info banner — only visible once a template is loaded */
    #template-header:not(:empty) {
      border: 1px solid var(--card-border);
      border-left: 3px solid var(--bs-info);
      border-radius: .5rem;
      padding: .7rem 1rem;
      margin-bottom: 1rem;
    }
    #template-header h3 {
      font-size: .95rem;
      font-weight: 600;
      margin-bottom: .15rem;
    }
    #template-header p {
      font-size: .85rem;
      color: var(--bs-secondary-color);
      margin-bottom: 0;
    }

    /* Dynamic form submit button */
    #report-form .btn-primary {
      margin-top: .5rem;
    }
  </style>
</head>
<body data-page="object">
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-8 col-md-7 col-sm-12">
        <div id="menu-container"></div>

        <div class="p-3">

          <!-- Page header -->
          <div class="mb-4">
            <div class="d-flex align-items-center gap-2 mb-1">
              <i class="fa-solid fa-cube fa-lg text-success" style="width:1.5rem;text-align:center"></i>
              <h2 class="mb-0 h3">Report via Object</h2>
            </div>
            <p class="text-secondary mb-0" style="padding-left:2.1rem;font-size:.875rem">
              Fill in a structured <a href="https://www.misp-project.org/objects.html" target="_blank">MISP object template</a>
              — each field maps directly to a typed MISP attribute.
            </p>
          </div>

          <!-- Shared metadata -->
          <div id="metadata-container"></div>

          <!-- Template selector card -->
          <div class="card card-dark mb-3">
            <div class="card-body">
              <label for="template-select" class="form-label fw-semibold mb-2" style="font-size:.875rem">
                Select template
              </label>
              <div class="tmpl-combobox" id="tmpl-combobox">
                <div class="tmpl-combobox-wrap">
                  <i class="fa-solid fa-magnifying-glass"></i>
                  <input
                    type="text"
                    id="template-select"
                    placeholder="Type to search templates…"
                    autocomplete="off"
                    spellcheck="false"
                  />
                  <button class="tmpl-clear" id="tmpl-clear" tabindex="-1" aria-label="Clear">
                    <i class="fa-solid fa-xmark"></i>
                  </button>
                </div>
                <div class="tmpl-dropdown" id="tmpl-dropdown">
                  <div class="tmpl-list" id="tmpl-list"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Template info banner (populated by JS) -->
          <div id="template-header"></div>

          <!-- Dynamic form (populated by JS) -->
          <div class="card card-dark">
            <div class="card-body" id="template-form">
              <p class="text-secondary mb-0" style="font-size:.875rem">
                <i class="fa-solid fa-arrow-up me-1"></i>Choose a template above to reveal the form.
              </p>
            </div>
          </div>

        </div>
      </div>

      <div class="col-lg-4 col-md-5 col-sm-12" id="tokenstore-container"></div>
    </div>
  </div>

  <script>
async function loadTemplate(name) {
  if (!baseUrl) await loadConfig();
  const url = `${baseUrl || window.location.origin}/object_templates?template=${encodeURIComponent(name)}`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Template fetch failed: ${res.status}`);
    const template = await res.json();

    // Root‐level required definitions
    const requiredFields = template.required      || [];
    const requiredOneOf  = template.requiredOneOf || [];

    // Populate header banner
    const headerEl = document.getElementById("template-header");
    headerEl.innerHTML = '';
    const h3 = document.createElement('h3');
    h3.textContent = `${template.name} v${template.version}`;
    headerEl.appendChild(h3);
    const descP = document.createElement('p');
    descP.textContent = template.description;
    headerEl.appendChild(descP);

    // Prepare form container
    const container = document.getElementById("template-form");
    container.innerHTML = "";
    const form = document.createElement("form");
    form.id = "report-form";

    // Sort attributes by ui-priority descending
    const entries = Object.entries(template.attributes || {}).sort(
      (a, b) => (b[1]["ui-priority"] || 0) - (a[1]["ui-priority"] || 0)
    );

    for (const [key, def] of entries) {
      const group = document.createElement("div");
      group.className = "mb-3";

      // Asterisk logic
      const isReq = requiredFields.includes(key);
      const isOne = requiredOneOf.includes(key);

      // Label
      const label = document.createElement("label");
      label.htmlFor = key;
      label.className = "form-label";
      label.textContent = key;
      if (isReq || isOne) {
        const star = document.createElement('span');
        star.className = isReq ? 'text-danger' : 'text-warning';
        star.textContent = ' *';
        label.appendChild(star);
      }
      if (def.description) {
        const help = document.createElement("small");
        help.className = "form-text text-muted d-block";
        help.textContent = def.description;
        label.appendChild(help);
      }
      group.appendChild(label);

      // Create input/select element
      let inputEl;
      const opts = def.values_list || def.sane_defaults;
      if (opts) {
        // <select> with 'undefined' default + options + custom if sane_defaults
        inputEl = document.createElement("select");
        inputEl.className = "form-select";
        const undefOpt = document.createElement("option");
        undefOpt.value = "";
        undefOpt.textContent = "undefined";
        undefOpt.selected = true;
        inputEl.appendChild(undefOpt);
        opts.forEach(val => {
          const o = document.createElement("option");
          o.value = val;
          o.textContent = val;
          inputEl.appendChild(o);
        });
        if (def.sane_defaults) {
          const customOpt = document.createElement("option");
          customOpt.value = "__custom__";
          customOpt.textContent = "Custom…";
          inputEl.appendChild(customOpt);

          const customInput = document.createElement("input");
          customInput.type = "text";
          customInput.name = `${key}_custom`;
          customInput.className = "form-control mt-2";
          customInput.placeholder = "Custom value";
          customInput.style.display = "none";
          group.appendChild(customInput);

          inputEl.addEventListener("change", () => {
            customInput.style.display =
              inputEl.value === "__custom__" ? "block" : "none";
          });
        }
      } else {
        // simple text input
        inputEl = document.createElement("input");
        inputEl.type = "text";
        inputEl.className = "form-control";
      }

      inputEl.id   = key;
      inputEl.name = key;
      if (isReq) inputEl.required = true;

      // ── MULTIPLE SUPPORT ─────────────────────────────────────
      if (def.multiple) {
        const multiWrap = document.createElement("div");
        multiWrap.className = "multiple-container";
        multiWrap.appendChild(inputEl);

        const addBtn = document.createElement("button");
        addBtn.type = "button";
        addBtn.className = "btn btn-sm btn-outline-secondary mt-1";
        addBtn.textContent = "Add another";
        addBtn.addEventListener("click", () => {
          const clone = inputEl.cloneNode(true);
          clone.value = "";
          multiWrap.insertBefore(clone, addBtn);
        });
        multiWrap.appendChild(addBtn);
        group.appendChild(multiWrap);
      } else {
        group.appendChild(inputEl);
      }

      form.appendChild(group);
    }

    // Submit button
    const submitBtn = document.createElement("button");
    submitBtn.type = "submit";
    submitBtn.className = "btn btn-primary btn-sm";
    submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane me-1"></i>Submit';
    form.appendChild(submitBtn);

    // onsubmit handler
    form.onsubmit = async e => {
      e.preventDefault();

      // 1) requiredOneOf check
      if (requiredOneOf.length) {
        const ok = requiredOneOf.some(k => {
          const el = form.elements[k];
          return el && String(el.value || "").trim() !== "";
        });
        if (!ok) {
          showToast(
            "Please fill at least one of: " + requiredOneOf.join(", "),
            false
          );
          return;
        }
      }

      // 2) Gather template fields under "data"
      const templateData = {};
      new FormData(form).forEach((val, key) => {
        if (val === "__custom__") return;
        const custom = form.elements[`${key}_custom`]?.value;
        if (templateData[key]) {
          Array.isArray(templateData[key])
            ? templateData[key].push(custom || val)
            : (templateData[key] = [templateData[key], custom || val]);
        } else {
          templateData[key] = custom || val;
        }
      });

      const metaContainer = document.getElementById('metadata-container');
      const meta = (metaContainer && typeof getMetadata === 'function') ? getMetadata() : {};

      // 3) Build payload
      const payload = {
        data: templateData,
        template_name: template.name,
        optional: meta
      };

      // 4) POST to backend
      let shareUrl = `${baseUrl || window.location.origin}/share/objects`;
      const params    = new URLSearchParams(window.location.search);
      const carryToken = params.get("token");
      if (carryToken) {
        const sep = shareUrl.includes('?') ? '&' : '?';
        shareUrl += `${sep}token=${encodeURIComponent(carryToken)}`;
      }

      try {
        const resp = await fetch(shareUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        let json;
        try { json = await resp.json(); } catch (_) { json = {}; }

        const detail = json.detail || json.error || json.message || null;

        if (resp.ok && json.status === "ok") {
          const tokens = getTokens();
          if (!tokens.includes(json.token)) {
            tokens.push(json.token);
            saveTokens(tokens);
          }
          showToast("Report submitted successfully!");
        } else {
          showToast(detail ? `Submission failed: ${detail}` : `Submission failed (HTTP ${resp.status})`, false);
        }
      } catch (networkErr) {
        console.error("Network error:", networkErr);
        showToast("Network error – please try again.", false);
      }
    };

    container.appendChild(form);

  } catch (err) {
    console.error("Error loading template:", err);
  }
}

async function loadTemplates() {
  if (!baseUrl) await loadConfig();
  const endpoint = `${baseUrl || window.location.origin}/object_templates`;

  try {
    const res = await fetch(endpoint);
    if (!res.ok) throw new Error(`Failed to fetch templates: ${res.status}`);
    const templates = await res.json();

    const input    = document.getElementById('template-select');
    const dropdown = document.getElementById('tmpl-dropdown');
    const listEl   = document.getElementById('tmpl-list');
    const clearBtn = document.getElementById('tmpl-clear');
    let focusIdx   = -1;

    // ── Helpers ───────────────────────────────────────────────────
    function escHtml(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    function highlightMatch(text, query) {
      if (!query) return escHtml(text);
      const lo  = text.toLowerCase();
      const idx = lo.indexOf(query.toLowerCase());
      if (idx === -1) return escHtml(text);
      return escHtml(text.slice(0, idx))
        + '<mark>' + escHtml(text.slice(idx, idx + query.length)) + '</mark>'
        + escHtml(text.slice(idx + query.length));
    }

    // ── Render filtered list ──────────────────────────────────────
    function renderList(query) {
      const q        = (query || '').toLowerCase();
      const filtered = templates.filter(t => t.toLowerCase().includes(q));
      focusIdx       = -1;
      listEl.innerHTML = '';

      if (filtered.length === 0) {
        const msg = document.createElement('div');
        msg.className   = 'tmpl-empty';
        msg.textContent = 'No matching templates';
        listEl.appendChild(msg);
        return;
      }

      filtered.forEach(name => {
        const item = document.createElement('div');
        item.className    = 'tmpl-item';
        item.dataset.name = name;
        item.innerHTML    = highlightMatch(name, query);
        item.addEventListener('mousedown', e => {
          e.preventDefault(); // keep focus on input
          selectTemplate(name);
        });
        listEl.appendChild(item);
      });
    }

    // ── Open / close ──────────────────────────────────────────────
    function openDropdown() {
      renderList(input.value.trim());
      dropdown.style.display = 'block';
    }

    function closeDropdown() {
      dropdown.style.display = 'none';
      focusIdx = -1;
    }

    // ── Select a template ─────────────────────────────────────────
    function selectTemplate(name) {
      input.value            = name;
      clearBtn.style.display = 'block';
      closeDropdown();
      loadTemplate(name);
    }

    // ── Keyboard focus movement ───────────────────────────────────
    function moveFocus(delta) {
      const items = listEl.querySelectorAll('.tmpl-item');
      if (!items.length) return;
      items[focusIdx]?.classList.remove('tmpl-focused');
      focusIdx = Math.max(0, Math.min(items.length - 1, focusIdx + delta));
      items[focusIdx].classList.add('tmpl-focused');
      items[focusIdx].scrollIntoView({ block: 'nearest' });
    }

    // ── Event wiring ──────────────────────────────────────────────
    input.addEventListener('focus', openDropdown);

    input.addEventListener('input', () => {
      const q = input.value.trim();
      clearBtn.style.display = q ? 'block' : 'none';
      openDropdown();
    });

    input.addEventListener('keydown', e => {
      if (dropdown.style.display === 'none') { openDropdown(); return; }
      if      (e.key === 'ArrowDown')  { e.preventDefault(); moveFocus(+1); }
      else if (e.key === 'ArrowUp')    { e.preventDefault(); moveFocus(-1); }
      else if (e.key === 'Escape')     { closeDropdown(); input.blur(); }
      else if (e.key === 'Enter') {
        e.preventDefault();
        const items   = listEl.querySelectorAll('.tmpl-item');
        const focused = items[focusIdx];
        if (focused) {
          selectTemplate(focused.dataset.name);
        } else {
          // Fall back to exact-match on typed value
          const match = templates.find(
            t => t.toLowerCase() === input.value.trim().toLowerCase()
          );
          if (match) selectTemplate(match);
        }
      }
    });

    input.addEventListener('blur', () => {
      // Delay so mousedown on items fires before blur closes the list
      setTimeout(closeDropdown, 150);
    });

    clearBtn.addEventListener('click', () => {
      input.value            = '';
      clearBtn.style.display = 'none';
      input.focus();
    });

    // Close on outside click
    document.addEventListener('click', e => {
      if (!document.getElementById('tmpl-combobox').contains(e.target)) {
        closeDropdown();
      }
    });

  } catch (err) {
    console.error('Error loading templates:', err);
  }
}

window.addEventListener('load', () => { loadTemplates(); });
  </script>

  <script src="js/bootstrap.bundle.min.js"></script>
</body>
</html>
