<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Draugnet – Report via CSV</title>

  <!-- CSS -->
  <link href="css/fontawesome.all.min.css" rel="stylesheet" />
  <link href="css/bootstrap.min.css" rel="stylesheet" />
  <link href="css/style.css" rel="stylesheet" />

  <!-- Core UI Scripts -->
  <script src="js/visualizer.js" defer></script>
  <script src="js/main.js"       defer></script>
  <script src="js/tokenstore.js" defer></script>
  <script src="js/menu.js"       defer></script>

  <!-- Metadata component & logic -->
  <script type="module" src="js/metadata.js" defer></script>

  <style>
    /* ── Table chrome ─────────────────────────────────────────── */
    #csv-table thead th {
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--bs-secondary-color);
      padding-bottom: .5rem;
      white-space: nowrap;
    }

    #csv-table thead th.col-req {
      color: var(--bs-body-color);
    }

    #csv-table thead th.col-req::after {
      content: ' *';
      color: var(--bs-warning);
      font-weight: 700;
    }

    /* ── Row animations ───────────────────────────────────────── */
    #csv-rows tr {
      animation: rowSlideIn .15s ease-out both;
    }

    @keyframes rowSlideIn {
      from { opacity: 0; transform: translateY(-6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ── Inputs ───────────────────────────────────────────────── */
    #csv-table input[type="text"] {
      font-family: 'Courier New', Courier, monospace;
      font-size: .82rem;
      background: transparent;
      border-color: rgba(255,255,255,.1);
      transition: border-color .15s, box-shadow .15s;
    }

    #csv-table input[type="text"]:focus {
      background: rgba(255,255,255,.04);
    }

    /* Required fields get a faint amber left-border accent */
    #csv-table input.is-req {
      border-left: 2px solid rgba(var(--bs-warning-rgb), .5);
    }

    #csv-table input.is-req:focus {
      border-color: var(--bs-warning);
      box-shadow: 0 0 0 .2rem rgba(var(--bs-warning-rgb), .15);
    }

    /* ── ISO datetime picker ──────────────────────────────────── */
    .iso-dt-wrap { position: relative; }

    .iso-dt-group {
      display: flex;
      align-items: stretch;
    }

    .iso-dt-text {
      flex: 1;
      min-width: 0;
      font-family: 'Courier New', Courier, monospace;
      font-size: .78rem;
      background: transparent;
      border-color: rgba(255,255,255,.1);
      border-right: none !important;
      border-radius: .25rem 0 0 .25rem !important;
      transition: border-color .15s, box-shadow .15s;
    }
    .iso-dt-text:focus {
      background: rgba(255,255,255,.04);
    }
    .iso-dt-text.iso-invalid {
      border-color: var(--bs-danger) !important;
    }
    .iso-dt-text.iso-invalid:focus {
      box-shadow: 0 0 0 .2rem rgba(var(--bs-danger-rgb),.18);
    }

    .iso-cal-btn {
      display: flex;
      align-items: center;
      background: transparent;
      border: 1px solid rgba(255,255,255,.1);
      border-left: none;
      border-radius: 0 .25rem .25rem 0;
      color: var(--bs-secondary-color);
      padding: 0 .42rem;
      cursor: pointer;
      transition: color .1s, background .1s;
      line-height: 1;
    }
    .iso-cal-btn:hover { color: var(--app-fg); background: rgba(255,255,255,.05); }

    .iso-drop {
      position: fixed;   /* escapes table overflow clipping */
      z-index: 9999;
      /* top/left set dynamically from getBoundingClientRect */
      background: var(--sidebar-bg);
      border: 1px solid var(--card-border);
      border-radius: .4rem;
      padding: .6rem .7rem;
      box-shadow: 0 8px 28px rgba(0,0,0,.5);
      min-width: 208px;
    }

    .iso-drop-label {
      font-size: .65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--bs-secondary-color);
      margin-bottom: .2rem;
    }

    .iso-drop input[type="date"],
    .iso-drop input[type="time"] {
      display: block;
      width: 100%;
      font-size: .8rem;
      font-family: 'Courier New', Courier, monospace;
      background: var(--input-bg);
      color: var(--input-fg);
      border: 1px solid var(--input-border);
      border-radius: .25rem;
      padding: .28rem .45rem;
      outline: none;
      transition: border-color .15s;
    }
    .iso-drop input[type="date"]:focus,
    .iso-drop input[type="time"]:focus { border-color: var(--bs-primary); }
    .iso-drop input[type="time"]:disabled { opacity: .3; cursor: not-allowed; }

    .iso-time-toggle-row {
      display: flex;
      align-items: center;
      gap: .35rem;
      margin: .4rem 0 .25rem;
      font-size: .75rem;
      color: var(--bs-secondary-color);
      cursor: pointer;
      user-select: none;
    }
    .iso-time-toggle-row input[type="checkbox"] { cursor: pointer; }

    .iso-drop-footer {
      display: flex;
      gap: .28rem;
      margin-top: .5rem;
      justify-content: flex-end;
    }
    .iso-drop-footer .btn {
      font-size: .7rem;
      padding: .18rem .5rem;
      line-height: 1.4;
    }

    /* ── Row number gutter ────────────────────────────────────── */
    .row-num {
      font-family: 'Courier New', Courier, monospace;
      font-size: .72rem;
      color: var(--bs-secondary-color);
      user-select: none;
      padding-right: .25rem;
    }

    /* ── Delete button ────────────────────────────────────────── */
    .btn-del {
      opacity: .35;
      transition: opacity .15s;
      line-height: 1;
    }

    .btn-del:not(:disabled):hover { opacity: 1; }
    .btn-del:disabled              { opacity: .12; cursor: default; }

    /* ── Add-row button ───────────────────────────────────────── */
    #btn-add-row {
      font-size: .82rem;
      letter-spacing: .04em;
    }

    /* ── Upload area ──────────────────────────────────────────── */
    #csv-upload-area {
      border: 1.5px dashed rgba(255,255,255,.18);
      border-radius: .375rem;
      padding: .75rem 1rem;
      display: flex;
      align-items: center;
      gap: .75rem;
      cursor: pointer;
      transition: border-color .15s, background .15s;
    }

    #csv-upload-area:hover {
      border-color: rgba(255,255,255,.38);
      background: rgba(255,255,255,.03);
    }

    #csv-upload-area.drag-over {
      border-color: var(--bs-info);
      background: rgba(var(--bs-info-rgb), .08);
    }

    #csv-upload-label {
      font-size: .82rem;
      color: var(--bs-secondary-color);
      margin: 0;
    }

    #csv-upload-label strong {
      color: var(--bs-body-color);
    }

    /* ── Col widths ───────────────────────────────────────────── */
    .col-num     { width: 2rem;  }
    .col-type    { width: 13%;  }
    .col-value   { width: 22%;  }
    .col-cat     { width: 12%;  }
    .col-date    { width: 13%;  }  /* wider to fit text + calendar button */
    .col-comment { /* fill */   }
    .col-del     { width: 2.5rem; }

    /* ── Type combobox ────────────────────────────────────────── */
    .type-combo-drop {
      position: fixed;
      z-index: 9998;
      background: var(--sidebar-bg);
      border: 1px solid var(--card-border);
      border-radius: .35rem;
      box-shadow: 0 6px 20px rgba(0,0,0,.45);
      max-height: 220px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .type-combo-item {
      padding: .28rem .65rem;
      font-size: .78rem;
      font-family: 'Courier New', Courier, monospace;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--app-fg);
    }
    .type-combo-item:hover,
    .type-combo-item.tc-active { background: var(--hover-bg); }

    .type-combo-item mark {
      background: transparent;
      color: var(--bs-warning);
      font-weight: 700;
    }

    .type-combo-empty {
      padding: .45rem .65rem;
      font-size: .78rem;
      color: var(--placeholder);
    }
  </style>
</head>
<body data-page="csv">
  <div class="container-fluid">
    <div class="row">

      <!-- ── Main content ─────────────────────────────────────── -->
      <div class="col-lg-8 col-md-7 col-sm-12">
        <div id="menu-container"></div>

        <div class="p-3">
          <!-- Page header -->
          <div class="mb-4">
            <div class="d-flex align-items-center gap-2 mb-1">
              <i class="fa-solid fa-table-list fa-lg text-primary" style="width:1.5rem;text-align:center"></i>
              <h2 class="mb-0 h3">Report via CSV</h2>
            </div>
            <p class="text-secondary mb-0" style="padding-left:2.1rem;font-size:.875rem">
              Upload a CSV file or build a table row by row — each line becomes a MISP attribute.
            </p>
          </div>

          <!-- Shared metadata accordion -->
          <div id="metadata-container"></div>

          <!-- CSV file upload -->
          <div id="csv-upload-area" class="mb-3"
               title="Click to upload a CSV file, or drag and drop one here">
            <i class="fa-solid fa-file-csv fa-lg text-info"></i>
            <div>
              <label id="csv-upload-label" style="cursor:pointer">
                <strong>Upload a CSV file</strong> — or fill the table below manually
              </label>
              <div id="csv-upload-hint" style="font-size:.75rem;color:var(--bs-secondary-color);margin-top:.1rem">
                Accepts .csv files. Headers: <code>type, value, category, first_seen, last_seen, comment</code>
                — dates as <code>YYYY-MM-DD</code> or <code>YYYY-MM-DDTHH:MM:SS</code>
              </div>
            </div>
            <input type="file" id="csv-file-input" accept=".csv,.txt" class="d-none">
          </div>

          <!-- OR divider -->
          <div class="d-flex align-items-center gap-2 mb-3" style="color:var(--bs-secondary-color);font-size:.75rem;letter-spacing:.08em;text-transform:uppercase">
            <hr class="flex-grow-1 m-0" style="border-color:rgba(255,255,255,.1)">
            <span>or fill manually</span>
            <hr class="flex-grow-1 m-0" style="border-color:rgba(255,255,255,.1)">
          </div>

          <!-- Attribute table -->
          <div class="card card-dark">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-sm table-borderless mb-0" id="csv-table">
                  <colgroup>
                    <col class="col-num">
                    <col class="col-type">
                    <col class="col-value">
                    <col class="col-cat">
                    <col class="col-date">
                    <col class="col-date">
                    <col class="col-comment">
                    <col class="col-del">
                  </colgroup>
                  <thead class="border-bottom border-secondary">
                    <tr>
                      <th class="col-num ps-3"></th>
                      <th class="col-req">Type</th>
                      <th class="col-req">Value</th>
                      <th>Category</th>
                      <th>First&nbsp;Seen</th>
                      <th>Last&nbsp;Seen</th>
                      <th>Comment</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="csv-rows"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Controls below table -->
          <div class="mt-2 d-flex align-items-center gap-2">
            <button id="btn-add-row" class="btn btn-outline-secondary btn-sm">
              <i class="fa-solid fa-plus me-1"></i>Add row
            </button>
            <button id="btn-submit-csv" class="btn btn-primary btn-sm">
              <i class="fa-solid fa-paper-plane me-1"></i>Submit
            </button>
          </div>

        </div>
      </div>

      <!-- ── Token sidebar ─────────────────────────────────────── -->
      <div class="col-lg-4 col-md-5 col-sm-12" id="tokenstore-container"></div>
    </div>
  </div>

  <!-- ── Submission logic ──────────────────────────────────────── -->
  <script type="module">
    import { getMetadata } from './js/metadata.js';

    const tbody = document.getElementById('csv-rows');

    /* ── CSV value escaping ──────────────────────────────────── */
    function escapeCSV(val) {
      const s = String(val ?? '');
      if (s.includes(',') || s.includes('"') || s.includes('\n') || s.includes('\r')) {
        return '"' + s.replace(/"/g, '""') + '"';
      }
      return s;
    }

    /* ── Keep row numbers and delete-button state in sync ─────── */
    function syncRows() {
      const rows = tbody.querySelectorAll('tr');
      rows.forEach((tr, i) => {
        tr.querySelector('.row-num').textContent = i + 1;
        tr.querySelector('.btn-del').disabled = rows.length === 1;
      });
    }

    /* ── Close all open ISO pickers when clicking outside ─────── */
    // Drop is appended to <body>, so also check .iso-drop directly
    document.addEventListener('click', e => {
      if (!e.target.closest('.iso-dt-wrap') && !e.target.closest('.iso-drop')) {
        document.querySelectorAll('.iso-drop:not([hidden])').forEach(d => { d.hidden = true; });
      }
    }, true);

    /* ── ISO 8601 validation regex (date or datetime) ─────────── */
    const ISO_RE = /^\d{4}-\d{2}-\d{2}(T\d{2}:\d{2}(:\d{2})?)?$/;

    /* ── MISP types + categories loaded from describeTypes.json ── */
    let allTypes      = [];
    let allCategories = [];
    let typeToCats    = {};   // type string → array of valid categories

    async function loadTypes() {
      try {
        const r = await fetch('describeTypes.json');
        const j = await r.json();
        allTypes = j?.result?.types ?? [];
        const catMap = j?.result?.category_type_mappings ?? {};
        allCategories = Object.keys(catMap);
        typeToCats = {};
        for (const [cat, types] of Object.entries(catMap)) {
          for (const t of types) {
            if (!typeToCats[t]) typeToCats[t] = [];
            typeToCats[t].push(cat);
          }
        }
      } catch (e) {
        console.warn('Could not load describeTypes.json — type/category suggestions unavailable.', e);
      }
    }

    /* Return valid categories for a given type (all categories if unknown) */
    function getValidCategories(currentType) {
      if (!currentType) return allCategories;
      const cats = typeToCats[currentType];
      return (cats && cats.length) ? cats : allCategories;
    }

    /* ── Generic filterable combobox (type, category, …) ─────── */
    function buildCombobox({ dataCol, placeholder, required, getItems }) {
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <input type="text"
               class="form-control form-control-sm${required ? ' is-req' : ''}"
               data-col="${dataCol}"
               placeholder="${placeholder}"
               autocomplete="off" spellcheck="false">
      `;

      // Dropdown portal — appended to <body> so the table never clips it
      const drop = document.createElement('div');
      drop.className = 'type-combo-drop';
      drop.hidden = true;
      document.body.appendChild(drop);
      wrap._drop = drop;

      const input = wrap.querySelector('input');

      function escRe(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

      function renderList() {
        const q        = input.value.trim().toLowerCase();
        const items    = getItems();
        const filtered = q ? items.filter(t => t.toLowerCase().includes(q)) : items;

        if (!filtered.length) {
          drop.innerHTML = '<div class="type-combo-empty">No matches</div>';
          return;
        }

        const re = q ? new RegExp(escRe(q), 'gi') : null;
        drop.innerHTML = filtered
          .map(t => {
            const hl = re ? t.replace(re, m => `<mark>${m}</mark>`) : t;
            return `<div class="type-combo-item" data-value="${t}">${hl}</div>`;
          })
          .join('');

        drop.querySelectorAll('.type-combo-item').forEach(item => {
          item.addEventListener('mousedown', e => {
            e.preventDefault();           // keep input focused
            input.value = item.dataset.value;
            closeDrop();
          });
        });
      }

      function openDrop() {
        if (!getItems().length) return;
        renderList();
        const rect  = input.getBoundingClientRect();
        const dropW = Math.max(rect.width, 180);
        const left  = Math.min(rect.left, window.innerWidth - dropW - 8);
        drop.style.width = dropW + 'px';
        drop.style.top   = (rect.bottom + 2) + 'px';
        drop.style.left  = Math.max(4, left) + 'px';
        drop.hidden = false;
      }

      function closeDrop() { drop.hidden = true; }

      function moveFocus(dir) {
        const items   = [...drop.querySelectorAll('.type-combo-item')];
        if (!items.length) return;
        const current = drop.querySelector('.tc-active');
        let idx = current ? items.indexOf(current) + dir : (dir > 0 ? 0 : items.length - 1);
        idx = Math.max(0, Math.min(idx, items.length - 1));
        if (current) current.classList.remove('tc-active');
        items[idx].classList.add('tc-active');
        items[idx].scrollIntoView({ block: 'nearest' });
      }

      input.addEventListener('focus', openDrop);
      input.addEventListener('input', () => { drop.hidden ? openDrop() : renderList(); });
      input.addEventListener('keydown', e => {
        if (drop.hidden) {
          if (e.key === 'ArrowDown' || e.key === 'ArrowUp') { e.preventDefault(); openDrop(); }
          return;
        }
        if      (e.key === 'ArrowDown') { e.preventDefault(); moveFocus(+1); }
        else if (e.key === 'ArrowUp')   { e.preventDefault(); moveFocus(-1); }
        else if (e.key === 'Enter') {
          const active = drop.querySelector('.tc-active');
          if (active) { e.preventDefault(); input.value = active.dataset.value; closeDrop(); }
        }
        else if (e.key === 'Escape') { closeDrop(); }
      });
      input.addEventListener('blur', () => setTimeout(closeDrop, 150));

      return wrap;
    }

    /* ── Build an ISO datetime picker widget ──────────────────── */
    function buildISOPicker(col) {
      // ── Input group (stays inside the table cell) ─────────────
      const wrap = document.createElement('div');
      wrap.className = 'iso-dt-wrap';
      wrap.innerHTML = `
        <div class="iso-dt-group">
          <input type="text"
                 class="form-control form-control-sm iso-dt-text"
                 data-col="${col}"
                 placeholder="YYYY-MM-DD"
                 autocomplete="off" spellcheck="false">
          <button type="button" class="iso-cal-btn" tabindex="-1"
                  title="Pick date / time">
            <i class="fa-regular fa-calendar-days fa-xs"></i>
          </button>
        </div>
      `;

      // ── Dropdown portal — appended to <body> to escape all
      //    table overflow/clipping contexts ──────────────────────
      const drop = document.createElement('div');
      drop.className = 'iso-drop';
      drop.hidden = true;
      drop.innerHTML = `
        <div class="iso-drop-label">Date</div>
        <input type="date" class="iso-date-part mb-1">
        <label class="iso-time-toggle-row">
          <input type="checkbox" class="iso-time-chk">
          Include time
        </label>
        <div class="iso-drop-label">Time (HH:MM:SS)</div>
        <input type="time" class="iso-time-part" step="1" disabled>
        <div class="iso-drop-footer">
          <button type="button" class="btn btn-outline-secondary iso-now-btn">Now</button>
          <button type="button" class="btn btn-outline-secondary iso-clear-btn">Clear</button>
          <button type="button" class="btn btn-primary iso-ok-btn">OK</button>
        </div>
      `;
      document.body.appendChild(drop);
      // Store ref on wrap so callers can clean it up on row removal
      wrap._isoDrop = drop;

      const textInput  = wrap.querySelector('.iso-dt-text');
      const calBtn     = wrap.querySelector('.iso-cal-btn');
      const datePart   = drop.querySelector('.iso-date-part');
      const timeChk    = drop.querySelector('.iso-time-chk');
      const timePart   = drop.querySelector('.iso-time-part');
      const nowBtn     = drop.querySelector('.iso-now-btn');
      const clearBtn   = drop.querySelector('.iso-clear-btn');
      const okBtn      = drop.querySelector('.iso-ok-btn');

      /* Write date+time pickers back to the text input */
      function commit() {
        const d = datePart.value;
        if (!d) { textInput.value = ''; return; }
        if (timeChk.checked && timePart.value) {
          const t = timePart.value;           // HH:MM or HH:MM:SS
          textInput.value = d + 'T' + (t.length === 5 ? t + ':00' : t);
        } else {
          textInput.value = d;
        }
        validate();
      }

      /* Populate pickers from the text input when opening */
      function loadFromText() {
        const v = textInput.value.trim();
        if (!v) { datePart.value = ''; timeChk.checked = false; timePart.disabled = true; timePart.value = ''; return; }
        const m = v.match(/^(\d{4}-\d{2}-\d{2})(T(\d{2}:\d{2}(:\d{2})?))?$/);
        if (!m) return;
        datePart.value = m[1];
        if (m[3]) {
          timeChk.checked = true; timePart.disabled = false; timePart.value = m[3];
        } else {
          timeChk.checked = false; timePart.disabled = true; timePart.value = '';
        }
      }

      function validate() {
        const v = textInput.value.trim();
        textInput.classList.toggle('iso-invalid', v !== '' && !ISO_RE.test(v));
      }

      calBtn.addEventListener('click', e => {
        e.stopPropagation();
        const wasHidden = drop.hidden;
        document.querySelectorAll('.iso-drop:not([hidden])').forEach(d => { d.hidden = true; });
        if (wasHidden) {
          // Position below the button, keeping the dropdown on-screen
          const rect = calBtn.getBoundingClientRect();
          const dropW = 212;
          const left  = Math.min(rect.left, window.innerWidth - dropW - 8);
          drop.style.top  = (rect.bottom + 4) + 'px';
          drop.style.left = Math.max(4, left) + 'px';
          drop.hidden = false;
          loadFromText();
          datePart.focus();
        }
      });

      timeChk.addEventListener('change', () => {
        timePart.disabled = !timeChk.checked;
        if (timeChk.checked) timePart.focus();
      });

      datePart.addEventListener('change', () => { if (!timeChk.checked) commit(); });
      timePart.addEventListener('change', commit);

      nowBtn.addEventListener('click', () => {
        const now = new Date();
        datePart.value = now.toISOString().slice(0, 10);
        timeChk.checked = true; timePart.disabled = false;
        timePart.value = now.toTimeString().slice(0, 8);
        commit();
      });

      clearBtn.addEventListener('click', () => {
        datePart.value = ''; timeChk.checked = false;
        timePart.disabled = true; timePart.value = '';
        textInput.value = '';
        textInput.classList.remove('iso-invalid');
        drop.hidden = true;
      });

      okBtn.addEventListener('click', () => { commit(); drop.hidden = true; });

      textInput.addEventListener('input', validate);
      textInput.addEventListener('blur',  validate);

      return wrap;
    }

    /* ── Tab out of last cell → add new row ──────────────────── */
    function onLastCellTab(e) {
      if (e.key === 'Tab' && !e.shiftKey) {
        const rows = tbody.querySelectorAll('tr');
        const lastRow = rows[rows.length - 1];
        // Exclude inputs inside the dropdown (not tab-reachable)
        const inputs = Array.from(lastRow.querySelectorAll('input'))
          .filter(i => !i.closest('.iso-drop'));
        if (document.activeElement === inputs[inputs.length - 1]) {
          e.preventDefault();
          addRow();
        }
      }
    }

    /* ── Build a single table row ─────────────────────────────── */
    function buildRow() {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="ps-3 align-middle"><span class="row-num">1</span></td>
        <td class="type-cell"></td>
        <td><input type="text" class="form-control form-control-sm is-req" data-col="value"   placeholder="required *"></td>
        <td class="cat-cell"></td>
        <td class="iso-cell" data-for="first_seen"></td>
        <td class="iso-cell" data-for="last_seen"></td>
        <td><input type="text" class="form-control form-control-sm"       data-col="comment"  placeholder="optional"></td>
        <td class="align-middle text-center pe-2">
          <button type="button" class="btn btn-outline-danger btn-sm btn-del"
                  title="Remove row" tabindex="-1">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </td>
      `;

      // All body-portal drops for this row — collected for unified cleanup
      const drops = [];

      const typeWrap = buildCombobox({ dataCol: 'type', placeholder: 'ip-dst *', required: true, getItems: () => allTypes });
      tr.querySelector('.type-cell').appendChild(typeWrap);
      drops.push(typeWrap._drop);

      const typeInput = typeWrap.querySelector('input');
      const catWrap = buildCombobox({
        dataCol: 'category', placeholder: 'optional', required: false,
        getItems: () => getValidCategories(typeInput.value.trim())
      });
      tr.querySelector('.cat-cell').appendChild(catWrap);
      drops.push(catWrap._drop);

      tr.querySelectorAll('.iso-cell').forEach(td => {
        const isoWrap = buildISOPicker(td.dataset.for);
        td.appendChild(isoWrap);
        drops.push(isoWrap._isoDrop);
      });

      tr._drops = drops;

      tr.querySelector('.btn-del').addEventListener('click', function () { removeRow(this); });
      tr.addEventListener('keydown', onLastCellTab);
      return tr;
    }

    /* ── Add a row ────────────────────────────────────────────── */
    function addRow(focusType = true) {
      const tr = buildRow();
      tbody.appendChild(tr);
      syncRows();
      if (focusType) tr.querySelector('[data-col="type"]').focus();
    }

    /* ── Remove all body-portal drops for a given row ─────────── */
    function cleanRowDrops(tr) {
      (tr._drops || []).forEach(d => d?.remove());
      tr._drops = [];
    }

    /* ── Remove a row ─────────────────────────────────────────── */
    function removeRow(btn) {
      if (tbody.querySelectorAll('tr').length <= 1) return;
      const tr = btn.closest('tr');
      cleanRowDrops(tr);
      tr.remove();
      syncRows();
    }

    /* ── Submit ───────────────────────────────────────────────── */
    async function submitCSV() {
      const rows       = Array.from(tbody.querySelectorAll('tr'));
      const attributes = [];

      for (let i = 0; i < rows.length; i++) {
        const get = col => rows[i].querySelector(`[data-col="${col}"]`).value.trim();

        const type      = get('type');
        const value     = get('value');
        const category  = get('category');
        const firstSeen = get('first_seen');
        const lastSeen  = get('last_seen');
        const comment   = get('comment');

        const anyFilled = type || value || category || firstSeen || lastSeen || comment;
        if (!anyFilled) continue;           // silently skip fully-empty rows

        if (!type || !value) {
          showToast(`Row ${i + 1}: "Type" and "Value" are both required.`, false);
          return;
        }

        if (firstSeen && !ISO_RE.test(firstSeen)) {
          showToast(`Row ${i + 1}: "First Seen" must be YYYY-MM-DD or YYYY-MM-DDTHH:MM:SS.`, false);
          return;
        }
        if (lastSeen && !ISO_RE.test(lastSeen)) {
          showToast(`Row ${i + 1}: "Last Seen" must be YYYY-MM-DD or YYYY-MM-DDTHH:MM:SS.`, false);
          return;
        }

        attributes.push({ type, value, category, first_seen: firstSeen, last_seen: lastSeen, comment });
      }

      if (attributes.length === 0) {
        showToast('Please fill in at least one row with Type and Value.', false);
        return;
      }

      /* Build CSV string */
      const header = 'type,value,category,first_seen,last_seen,comment';
      const lines  = attributes.map(a =>
        ['type','value','category','first_seen','last_seen','comment']
          .map(k => escapeCSV(a[k]))
          .join(',')
      );
      const csvString = [header, ...lines].join('\n');

      /* Metadata */
      const metaContainer = document.getElementById('metadata-container');
      const meta = (metaContainer && typeof getMetadata === 'function') ? getMetadata() : {};

      /* Endpoint */
      let endpoint = (typeof baseUrl !== 'undefined' && baseUrl)
        ? `${baseUrl}/share/csv`
        : `${window.location.origin}/share/csv`;
      const carryToken = new URLSearchParams(window.location.search).get('token');
      if (carryToken) endpoint += `?token=${encodeURIComponent(carryToken)}`;

      try {
        const res    = await fetch(endpoint, {
          method:  'POST',
          headers: { 'Content-Type': 'application/json' },
          body:    JSON.stringify({ csv: csvString, optional: meta }),
        });
        const result = await res.json();

        if (res.ok && result.status === 'ok') {
          const tokens = getTokens();
          if (!tokens.includes(result.token)) {
            tokens.push(result.token);
            saveTokens(tokens);
          }
          showToast('CSV report submitted successfully!');
        } else {
          showToast(result.detail || 'Submission failed.', false);
        }
      } catch (err) {
        showToast('Network error or invalid response.', false);
        console.error(err);
      }
    };

    /* ── CSV file upload ──────────────────────────────────────── */
    function parseCSVLine(line) {
      // RFC-4180 aware single-line parser
      const fields = [];
      let cur = '', inQuote = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (inQuote) {
          if (ch === '"' && line[i + 1] === '"') { cur += '"'; i++; }
          else if (ch === '"')                    { inQuote = false; }
          else                                    { cur += ch; }
        } else {
          if      (ch === '"') { inQuote = true; }
          else if (ch === ',') { fields.push(cur); cur = ''; }
          else                 { cur += ch; }
        }
      }
      fields.push(cur);
      return fields;
    }

    function loadCSVFile(file) {
      const reader = new FileReader();
      reader.onload = e => {
        const text  = e.target.result.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        const lines = text.split('\n').filter(l => l.trim() !== '');
        if (lines.length < 2) {
          showToast('CSV must have a header row and at least one data row.', false);
          return;
        }

        const KNOWN_COLS = ['type','value','category','first_seen','last_seen','comment'];
        const rawHeaders = parseCSVLine(lines[0]).map(h => h.trim().toLowerCase());

        // Validate that at least type and value are present
        if (!rawHeaders.includes('type') || !rawHeaders.includes('value')) {
          showToast('CSV must have "type" and "value" columns.', false);
          return;
        }

        // Clear existing rows — remove body-appended drops first
        tbody.querySelectorAll('tr').forEach(cleanRowDrops);
        tbody.innerHTML = '';
        let loaded = 0;

        for (let i = 1; i < lines.length; i++) {
          const fields = parseCSVLine(lines[i]);
          const row    = {};
          rawHeaders.forEach((h, idx) => {
            if (KNOWN_COLS.includes(h)) row[h] = (fields[idx] || '').trim();
          });

          // Skip completely empty data rows
          if (KNOWN_COLS.every(k => !row[k])) continue;

          const tr = buildRow();
          KNOWN_COLS.forEach(col => {
            const input = tr.querySelector(`[data-col="${col}"]`);
            if (input && row[col]) input.value = row[col];
          });
          tbody.appendChild(tr);
          loaded++;
        }

        if (loaded === 0) {
          // No valid data rows — restore one blank row
          tbody.appendChild(buildRow());
          showToast('No data rows found in the CSV.', false);
        } else {
          syncRows();
          const hint = document.getElementById('csv-upload-hint');
          if (hint) hint.textContent = `Loaded ${loaded} row${loaded !== 1 ? 's' : ''} from "${file.name}" — review and submit below.`;
          showToast(`Loaded ${loaded} row${loaded !== 1 ? 's' : ''} from CSV.`);
        }

        // Reset file input so the same file can be re-uploaded
        document.getElementById('csv-file-input').value = '';
      };
      reader.onerror = () => showToast('Could not read the file.', false);
      reader.readAsText(file);
    }

    /* ── Wire up file input and drag-and-drop ─────────────────── */
    const fileInput  = document.getElementById('csv-file-input');
    const uploadArea = document.getElementById('csv-upload-area');

    // Prevent the programmatic .click() from bubbling back to uploadArea
    fileInput.addEventListener('click', e => e.stopPropagation());

    fileInput.addEventListener('change', () => {
      if (fileInput.files[0]) loadCSVFile(fileInput.files[0]);
    });

    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', e => {
      e.preventDefault();
      uploadArea.classList.add('drag-over');
    });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
    uploadArea.addEventListener('drop', e => {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');
      const file = e.dataTransfer?.files[0];
      if (file) loadCSVFile(file);
    });

    /* ── Wire up static buttons ───────────────────────────────── */
    document.getElementById('btn-add-row').addEventListener('click', addRow);
    document.getElementById('btn-submit-csv').addEventListener('click', submitCSV);

    /* ── Load types then seed the first row ──────────────────── */
    loadTypes().then(() => addRow(false));
  </script>

  <script src="js/bootstrap.bundle.min.js"></script>
</body>
</html>
