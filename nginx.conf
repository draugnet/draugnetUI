server {
    listen 80;
    root /usr/share/nginx/html;
    index index.html;

    # ── Security headers ──────────────────────────────────────────────────
    # Defined in each location block because nginx location blocks completely
    # replace (not inherit) server-level add_header directives.
    #
    # CSP notes:
    #   - script-src needs 'unsafe-inline' while inline <script> blocks exist
    #   - connect-src is unrestricted because the backend URL is user-configured
    #   - object-src 'none' disables Flash/plugins entirely
    #   - base-uri 'self' prevents <base> tag injection

    # HTML files: revalidate on every request so fragment updates
    # (menu.html, tokenstore.html, metadata.html) reach users immediately.
    location ~* \.html$ {
        add_header Cache-Control "no-cache" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src *; object-src 'none'; base-uri 'self'" always;
    }

    # Static assets (JS, CSS, images, fonts): cache aggressively.
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf)$ {
        add_header Cache-Control "public, max-age=31536000, immutable" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src *; object-src 'none'; base-uri 'self'" always;
    }

    # Everything else (config.json, etc.): security headers, no special caching.
    location / {
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src *; object-src 'none'; base-uri 'self'" always;
    }
}
