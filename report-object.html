<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FastAPI SPA – Report via Object</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link href="style.css" rel="stylesheet" />
  <style>
    /* Enhance template selection */
    #template-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    .template-button {
      flex: 1 1 200px;
      text-align: center;
      padding: 0.75rem 1rem;
      border: 1px solid var(--card-border);
      border-radius: 0.5rem;
      background-color: var(--card-bg);
      color: var(--app-fg);
      transition: background-color 0.2s, transform 0.2s;
      cursor: pointer;
    }
    .template-button:hover {
      background-color: var(--hover-bg);
      transform: translateY(-2px);
    }
    .template-button:active {
      transform: translateY(0);
    }

    /* Styling for the template header */
    #template-header {
      margin-bottom: 1rem;
      padding: 1rem;
      background-color: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 0.5rem;
    }
    #template-header h3 {
      margin: 0;
      font-weight: bold;
      color: var(--app-fg);
    }
    #template-header p {
      margin-top: 0.5rem;
      color: var(--app-fg);
      opacity: 0.85;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Main content column -->
      <div class="col-lg-8 col-md-7 col-sm-12">
        <!-- Shared menu placeholder -->
        <div id="menu-container"></div>

        <div class="p-3">
          <h2 class="mb-4">Report via Object</h2>
          <div id="template-list" class="mb-3"></div>
          <div id="template-header"></div>
          <div class="card card-dark">
            <div class="card-body" id="template-form"></div>
          </div>
        </div>
      </div>

      <!-- Token store column -->
      <div class="col-lg-4 col-md-5 col-sm-12" id="tokenstore-container"></div>
    </div>
  </div>

  <!-- Toast notification -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div
      id="toast"
      class="toast text-white bg-success"
      role="alert"
      aria-live="assertive"
      aria-atomic="true"
    >
      <div class="toast-header bg-success text-white">
        <strong class="me-auto">Notification</strong>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="toast"
          aria-label="Close"
        ></button>
      </div>
      <div class="toast-body" id="toast-body">Message goes here.</div>
    </div>
  </div>

  <script>
    let baseUrl = "";

    async function loadConfig() {
      try {
        const res = await fetch("config.json");
        const config = await res.json();
        baseUrl = config.baseUrl || config.baseurl || "";
      } catch (e) {
        console.error("Error loading config.json:", e);
      }
    }

    function showToast(message, success = true) {
      const toastEl = document.getElementById("toast");
      document.getElementById("toast-body").innerText = message;
      toastEl.classList.remove("bg-success", "bg-danger");
      toastEl.classList.add(success ? "bg-success" : "bg-danger");
      new bootstrap.Toast(toastEl).show();
    }

    function getTokens() {
      return JSON.parse(localStorage.getItem("tokens") || "[]");
    }

    function saveTokens(tokens) {
      localStorage.setItem("tokens", JSON.stringify(tokens));
      renderTokenList();
    }

    function renderTokenList() {
      const tokens = getTokens();
      const list = document.getElementById("token-list");
      if (!list) return;
      list.innerHTML = "";
      tokens.forEach((token) => {
        const li = document.createElement("li");
        li.textContent = token;
        li.className = "token-item text-truncate";
        li.onclick = () => {
          window.location.href = `view.html?token=${encodeURIComponent(token)}`;
        };
        list.appendChild(li);
      });
    }

    function addToken() {
      const input = document.getElementById("new-token");
      const token = input.value.trim();
      if (token) {
        const tokens = getTokens();
        if (!tokens.includes(token)) {
          tokens.push(token);
          saveTokens(tokens);
        }
        input.value = "";
      }
    }

    function downloadTokens() {
      const tokens = getTokens();
      const blob = new Blob([tokens.join("\n")], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "tokens.txt";
      a.click();
      URL.revokeObjectURL(url);
    }

    // ─── Theme setup ─────────────────────────────────────────────────────────
    function setupTheme() {
      const saved = localStorage.getItem("preferred-theme") || "dark";
      document.documentElement.setAttribute("data-bs-theme", saved);

      const toggle = document.getElementById("theme-toggle");
      if (toggle) {
        toggle.checked = saved === "dark";
        toggle.addEventListener("change", () => {
          const newTheme = toggle.checked ? "dark" : "light";
          document.documentElement.setAttribute("data-bs-theme", newTheme);
          localStorage.setItem("preferred-theme", newTheme);
        });
      }
    }

    // ─── Load shared menu & highlight “report-object” ─────────────────────────
    async function loadMenu() {
      const res = await fetch("menu.html");
      if (!res.ok) return;
      const html = await res.text();
      document.getElementById("menu-container").innerHTML = html;

      // Apply saved theme and wire toggle
      setupTheme();

      // Highlight “report-object” tab
      document.querySelectorAll("#menu-container .nav-link").forEach((link) => {
        const page = link.getAttribute("data-page");
        link.classList.toggle("active", page === "report-object");
      });
    }

    // ─── Load token‐store panel ────────────────────────────────────────────────
    async function loadTokenStore() {
      const res = await fetch("tokenstore.html");
      if (!res.ok) return;
      const html = await res.text();
      document.getElementById("tokenstore-container").innerHTML = html;
      renderTokenList();
    }

    // ─── Load & render object templates ─────────────────────────────────────
    async function loadTemplates() {
      if (!baseUrl) await loadConfig();
      const endpoint = baseUrl
        ? `${baseUrl}/object_templates`
        : `${window.location.origin}/object_templates`;
      try {
        const res = await fetch(endpoint);
        if (!res.ok) {
          console.error("Error fetching templates:", res.status);
          return;
        }
        const templates = await res.json();
        const list = document.getElementById("template-list");
        if (!list) return;
        list.innerHTML = "";
        templates.forEach((name) => {
          const btn = document.createElement("div");
          btn.textContent = name;
          btn.className = "template-button";
          btn.onclick = () => loadTemplate(name);
          list.appendChild(btn);
        });
      } catch (err) {
        console.error("Network error when fetching templates:", err);
      }
    }

    async function loadTemplate(name) {
      if (!baseUrl) await loadConfig();
      const endpoint = baseUrl
        ? `${baseUrl}/object_templates?template=${encodeURIComponent(name)}`
        : `${window.location.origin}/object_templates?template=${encodeURIComponent(name)}`;
      try {
        const res2 = await fetch(endpoint);
        if (!res2.ok) {
          console.error("Error fetching template details:", res2.status);
          return;
        }
        const template = await res2.json();

        // Create header with name, version, and description
        const headerDiv = document.getElementById("template-header");
        headerDiv.innerHTML = `
          <h3>${template.name} v${template.version}</h3>
          <p>${template.description}</p>
        `;

        const container = document.getElementById("template-form");
        if (!container) return;
        container.innerHTML = "";
        const form = document.createElement("form");
        form.id = "report-form";

        const attrEntries = Object.entries(template.attributes).sort(
          (a, b) => (b[1]["ui-priority"] || 0) - (a[1]["ui-priority"] || 0)
        );

        attrEntries.forEach(([key, value]) => {
          const div = document.createElement("div");
          div.className = "mb-3";
          const label = document.createElement("label");

          if (template.required && template.required.includes(key)) {
            label.className = "form-label required";
          } else if (template.requiredOneOf && template.requiredOneOf.includes(key)) {
            label.className = "form-label required-one-of";
          } else {
            label.className = "form-label";
          }
          label.textContent = `${key} (${value.description}) [${value["misp-attribute"]}]`;
          div.appendChild(label);

          if (value.values_list || value.sane_defaults) {
            const select = document.createElement("select");
            select.className = "form-select mb-2";
            select.name = key;
            const vals = value.values_list || value.sane_defaults;
            vals.forEach((opt) => {
              const o = document.createElement("option");
              o.value = opt;
              o.textContent = opt;
              select.appendChild(o);
            });
            if (value.sane_defaults) {
              const o = document.createElement("option");
              o.value = "__custom__";
              o.textContent = "Custom...";
              select.appendChild(o);
              const inpt = document.createElement("input");
              inpt.className = "form-control mt-2";
              inpt.name = `${key}_custom`;
              inpt.placeholder = "Custom value";
              inpt.style.display = "none";
              select.onchange = () => {
                inpt.style.display = select.value === "__custom__" ? "block" : "none";
              };
              div.appendChild(select);
              div.appendChild(inpt);
            } else {
              div.appendChild(select);
            }
          } else if (value.multiple) {
            const ta = document.createElement("textarea");
            ta.className = "form-control";
            ta.name = key;
            ta.placeholder = "Enter one per line";
            div.appendChild(ta);
          } else {
            const inpt = document.createElement("input");
            inpt.className = "form-control";
            inpt.name = key;
            div.appendChild(inpt);
          }
          form.appendChild(div);
        });

        const submitBtn = document.createElement("button");
        submitBtn.type = "submit";
        submitBtn.className = "btn btn-primary";
        submitBtn.textContent = "Submit";
        form.appendChild(submitBtn);

        form.onsubmit = async (e) => {
          e.preventDefault();
          const data = {};
          const fd = new FormData(form);
          for (const [key, value] of fd.entries()) {
            if (key.endsWith("_custom")) continue;
            const custom = fd.get(`${key}_custom`);
            if (custom && fd.get(key) === "__custom__") {
              data[key] = custom;
            } else if (data[key]) {
              if (Array.isArray(data[key])) data[key].push(value);
              else data[key] = [data[key], value];
            } else {
              data[key] = value.includes("\n") ? value.split("\n").filter(Boolean) : value;
            }
          }

          const shareUrl = baseUrl
            ? `${baseUrl}/share/objects`
            : `${window.location.origin}/share/objects`;
          const res3 = await fetch(shareUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          const json = await res3.json();
          if (json.success) {
            const tokens = getTokens();
            if (!tokens.includes(json.token)) {
              tokens.push(json.token);
              saveTokens(tokens);
            }
            showToast("Report submitted successfully!");
          } else {
            showToast("Submission failed.", false);
          }
        };

        container.appendChild(form);
      } catch (err) {
        console.error("Error fetching template details:", err);
      }
    }

    window.addEventListener("load", async () => {
      await loadConfig();
      await loadMenu();
      await loadTokenStore();
      loadTemplates();
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
